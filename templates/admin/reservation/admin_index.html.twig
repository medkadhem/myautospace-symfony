{% extends 'admin/base.html.twig' %}

{% block title %}Manage All Reservations - Admin{% endblock %}

{% block body %}
<div class="admin-reservations-container">
  <div class="admin-header">
    <div>
      <h1>üõ°Ô∏è Manage All Reservations</h1>
      <p style="color: var(--muted); margin: 8px 0 0;">Admin view of all platform reservations</p>
    </div>
    <a href="{{ path('app_admin_dashboard') }}" class="btn secondary">‚Üê Back to Admin</a>
  </div>

  <!-- Statistics -->
  <div class="stats-row">
    <div class="stat-box pending">
      <div class="stat-number">{{ reservations|filter(r => r.status == 'pending')|length }}</div>
      <div class="stat-label">Pending</div>
    </div>
    <div class="stat-box confirmed">
      <div class="stat-number">{{ reservations|filter(r => r.status == 'confirmed')|length }}</div>
      <div class="stat-label">Confirmed</div>
    </div>
    <div class="stat-box completed">
      <div class="stat-number">{{ reservations|filter(r => r.status == 'completed')|length }}</div>
      <div class="stat-label">Completed</div>
    </div>
    <div class="stat-box cancelled">
      <div class="stat-number">{{ reservations|filter(r => r.status == 'cancelled')|length }}</div>
      <div class="stat-label">Cancelled</div>
    </div>
  </div>

  {% if reservations|length > 0 %}
  <!-- Table -->
  <div class="table-card">
    <div class="table-header">
      <h2>All Reservations ({{ reservations|length }})</h2>
      <input type="text" id="searchInput" placeholder="Search by client, provider, or service..." class="search-input">
    </div>
    
    <div class="table-wrapper">
      <table class="admin-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Client</th>
            <th>Provider</th>
            <th>Item</th>
            <th>Type</th>
            <th>Date</th>
            <th>Time</th>
            <th>Price</th>
            <th>Status</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          {% for reservation in reservations %}
          <tr data-status="{{ reservation.status }}">
            <td><strong>#{{ reservation.id }}</strong></td>
            <td>
              <div class="user-cell">
                <div class="user-avatar-small">{{ reservation.client.email|upper|first }}</div>
                <div>
                  <div class="user-name">{{ reservation.client.fullName ? reservation.client.fullName : reservation.client.email }}</div>
                  <div class="user-email">{{ reservation.client.email }}</div>
                </div>
              </div>
            </td>
            <td>
              <div class="user-cell">
                <div class="user-avatar-small">{{ reservation.provider.email|upper|first }}</div>
                <div>
                  <div class="user-name">{{ reservation.provider.fullName ? reservation.provider.fullName : reservation.provider.email }}</div>
                  <div class="user-email">{{ reservation.provider.email }}</div>
                </div>
              </div>
            </td>
            <td>
              {% if reservation.service %}
                {{ reservation.service.title }}
              {% else %}
                {{ reservation.announcement.title }}
              {% endif %}
            </td>
            <td>
              {% if reservation.service %}
                <span class="type-badge service">üîß Service</span>
              {% else %}
                <span class="type-badge listing">üöó Listing</span>
              {% endif %}
            </td>
            <td>{{ reservation.reservationDate|date('M d, Y') }}</td>
            <td>
              {% if reservation.startTime %}
                {{ reservation.startTime|date('H:i') }}
              {% else %}
                -
              {% endif %}
            </td>
            <td><strong>{{ reservation.price|number_format(0, '.', ',') }} TND</strong></td>
            <td>
              <span class="badge badge-{{ reservation.status }}">{{ reservation.status|capitalize }}</span>
            </td>
            <td>{{ reservation.createdAt|date('M d, H:i') }}</td>
            <td>
              <div class="action-btns">
                <a href="{{ path('app_admin_reservation_show', {id: reservation.id}) }}" class="btn-icon" title="View">üëÅÔ∏è</a>
                <a href="{{ path('app_admin_reservation_edit', {id: reservation.id}) }}" class="btn-icon" title="Edit">‚úèÔ∏è</a>
                <form method="post" action="{{ path('app_admin_reservation_delete', {id: reservation.id}) }}" onsubmit="return confirm('Delete this reservation?');" style="display: inline;">
                  <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ reservation.id) }}">
                  <button type="submit" class="btn-icon delete" title="Delete">üóëÔ∏è</button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% else %}
  <div class="empty-state">
    <div class="empty-icon">üì≠</div>
    <h3>No Reservations</h3>
    <p>No reservations have been made yet.</p>
  </div>
  {% endif %}
</div>

<style>
  .admin-reservations-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 40px 20px;
  }

  .admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
    flex-wrap: wrap;
    gap: 20px;
  }

  .admin-header h1 {
    font-size: 32px;
    margin: 0 0 8px;
  }

  /* Stats Row */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
  }

  .stat-box {
    background: var(--card);
    padding: 24px;
    border-radius: 12px;
    border: 2px solid rgba(255, 255, 255, 0.1);
    text-align: center;
  }

  .stat-box.pending {
    border-color: rgba(243, 156, 18, 0.4);
    background: linear-gradient(135deg, rgba(243, 156, 18, 0.05) 0%, var(--card) 100%);
  }

  .stat-box.confirmed {
    border-color: rgba(40, 167, 69, 0.4);
    background: linear-gradient(135deg, rgba(40, 167, 69, 0.05) 0%, var(--card) 100%);
  }

  .stat-box.completed {
    border-color: rgba(23, 162, 184, 0.4);
    background: linear-gradient(135deg, rgba(23, 162, 184, 0.05) 0%, var(--card) 100%);
  }

  .stat-box.cancelled {
    border-color: rgba(220, 53, 69, 0.4);
    background: linear-gradient(135deg, rgba(220, 53, 69, 0.05) 0%, var(--card) 100%);
  }

  .stat-number {
    font-size: 36px;
    font-weight: 700;
    margin-bottom: 8px;
  }

  .stat-label {
    font-size: 14px;
    color: var(--muted);
    text-transform: uppercase;
    font-weight: 600;
  }

  /* Table Card */
  .table-card {
    background: var(--card);
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .table-header {
    padding: 24px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
  }

  .table-header h2 {
    margin: 0;
    font-size: 20px;
  }

  .search-input {
    padding: 10px 16px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.05);
    color: var(--text);
    font-size: 14px;
    min-width: 300px;
  }

  .search-input:focus {
    background: rgba(255, 255, 255, 0.08);
    border-color: var(--accent);
    outline: none;
  }

  .table-wrapper {
    overflow-x: auto;
  }

  .admin-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }

  .admin-table thead {
    background: var(--bg-secondary);
  }

  .admin-table th {
    padding: 16px 12px;
    text-align: left;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    font-size: 12px;
    white-space: nowrap;
  }

  .admin-table td {
    padding: 16px 12px;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
  }

  .admin-table tbody tr:hover {
    background: rgba(255, 255, 255, 0.03);
  }

  .admin-table tbody tr[data-status="pending"] {
    border-left: 3px solid #f39c12;
  }

  .admin-table tbody tr[data-status="confirmed"] {
    border-left: 3px solid #28a745;
  }

  .admin-table tbody tr[data-status="completed"] {
    border-left: 3px solid #17a2b8;
  }

  .admin-table tbody tr[data-status="cancelled"] {
    border-left: 3px solid #dc3545;
    opacity: 0.6;
  }

  .user-cell {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .user-avatar-small {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--accent);
    color: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 12px;
    flex-shrink: 0;
  }

  .user-name {
    font-weight: 600;
    font-size: 13px;
  }

  .user-email {
    font-size: 11px;
    color: var(--muted);
  }

  .type-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 600;
  }

  .type-badge.service {
    background: rgba(248, 231, 28, 0.2);
    color: var(--accent);
  }

  .type-badge.listing {
    background: rgba(23, 162, 184, 0.2);
    color: #17a2b8;
  }

  .action-btns {
    display: flex;
    gap: 6px;
  }

  .btn-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    background: var(--bg-secondary);
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 16px;
  }

  .btn-icon:hover {
    background: var(--accent);
    transform: scale(1.1);
  }

  .btn-icon.delete:hover {
    background: #dc3545;
  }

  .badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
  }

  .badge-pending {
    background: rgba(243, 156, 18, 0.2);
    color: #f39c12;
  }

  .badge-confirmed {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
  }

  .badge-completed {
    background: rgba(23, 162, 184, 0.2);
    color: #17a2b8;
  }

  .badge-cancelled {
    background: rgba(220, 53, 69, 0.2);
    color: #dc3545;
  }

  .empty-state {
    text-align: center;
    padding: 80px 20px;
    background: var(--card);
    border-radius: 16px;
    border: 2px dashed rgba(255, 255, 255, 0.1);
  }

  .empty-icon {
    font-size: 64px;
    margin-bottom: 20px;
    opacity: 0.5;
  }

  .empty-state h3 {
    font-size: 24px;
    margin: 0 0 12px;
  }

  .empty-state p {
    color: var(--muted);
    margin: 0;
    font-size: 16px;
  }

  @media (max-width: 768px) {
    .admin-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .search-input {
      width: 100%;
      min-width: auto;
    }

    .admin-table {
      font-size: 12px;
    }

    .admin-table th,
    .admin-table td {
      padding: 10px 8px;
    }
  }
</style>

<script>
  // Search functionality
  const searchInput = document.getElementById('searchInput');
  if (searchInput) {
    searchInput.addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#tableBody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });
  }
</script>
{% endblock %}
