{% extends 'base.html.twig' %}

{% block title %}Provider Dashboard - MyAutoSpace{% endblock %}

{% block body %}
<div class="dashboard-container">
  <div class="dashboard-header">
    <div>
      <h1>Provider Dashboard</h1>
      <p style="color: var(--muted); margin: 8px 0 0;">Manage your services and car listings</p>
    </div>
    <div class="dashboard-header-actions">
      <a href="{{ path('app_service_new') }}" class="btn yellow btn-lg">+ Add Service</a>
      <a href="{{ path('app_announcement_new') }}" class="btn yellow btn-lg">+ Add Listing</a>
    </div>
  </div>

  <div class="dashboard-stats">
    <div class="stat-card">
      <div class="stat-icon">üîß</div>
      <div class="stat-label">Active Services</div>
      <div class="stat-value">{{ activeServices }}</div>
      <div class="stat-change">Published</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üöó</div>
      <div class="stat-label">Active Listings</div>
      <div class="stat-value">{{ activeListings }}</div>
      <div class="stat-change">Car listings</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üìÖ</div>
      <div class="stat-label">Total Bookings</div>
      <div class="stat-value">{{ totalReservations }}</div>
      <div class="stat-change">All time</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">‚è≥</div>
      <div class="stat-label">Pending Requests</div>
      <div class="stat-value">{{ pendingReservations }}</div>
      <div class="stat-change">Awaiting approval</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">‚≠ê</div>
      <div class="stat-label">Rating</div>
      <div class="stat-value">{{ averageRating > 0 ? averageRating : 'N/A' }}</div>
      <div class="stat-change">Client feedback</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üí∞</div>
      <div class="stat-label">Listings Value</div>
      <div class="stat-value">{{ totalValue|number_format(0, '.', ' ') }} TND</div>
      <div class="stat-change">Total value</div>
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="dashboard-card">
      <span class="card-icon">üîß</span>
      <h3>My Services</h3>
      <p>View and manage your service offerings</p>
      <a href="{{ path('app_service_index') }}" class="btn yellow btn-block">View Services</a>
    </div>

    <div class="dashboard-card">
      <span class="card-icon">üöó</span>
      <h3>Car Listings</h3>
      <p>Manage your vehicle listings</p>
      <a href="{{ path('app_announcement_my_listings') }}" class="btn yellow btn-block">View Listings</a>
    </div>

    <div class="dashboard-card">
      <span class="card-icon">üìÖ</span>
      <h3>Bookings & Reservations</h3>
      <p>Manage and confirm booking requests</p>
      <a href="{{ path('app_reservation_index') }}" class="btn secondary btn-block">View All</a>
    </div>

    <div class="dashboard-card">
      <span class="card-icon">üí¨</span>
      <h3>Offers Received</h3>
      <p>View and manage offers on your listings</p>
      <div style="display: flex; align-items: center; gap: 8px;">
        <a href="{{ path('app_offer_received') }}" class="btn secondary btn-block">View Offers</a>
        {% if pendingOffers > 0 %}
          <span class="unread-badge">{{ pendingOffers }}</span>
        {% endif %}
      </div>
    </div>

    <div class="dashboard-card">
      <span class="card-icon">üìß</span>
      <h3>Messages</h3>
      <p>Chat with clients about listings</p>
      <div style="display: flex; align-items: center; gap: 8px;">
        <a href="{{ path('app_messages') }}" class="btn secondary btn-block">Inbox</a>
        {% if unreadMessages > 0 %}
          <span class="unread-badge">{{ unreadMessages }}</span>
        {% endif %}
      </div>
    </div>

    <div class="dashboard-card">
      <span class="card-icon">‚≠ê</span>
      <h3>Reviews & Ratings</h3>
      <p>Check customer feedback and ratings</p>
      <a href="{{ path('app_review_index') }}" class="btn secondary btn-block">See Reviews</a>
    </div>
  </div>

  <!-- Pending Reservations - Action Required -->
  {% if pendingReservations > 0 %}
  <div class="dashboard-section" style="background: rgba(243, 156, 18, 0.1); border: 2px solid rgba(243, 156, 18, 0.3); border-radius: 12px; padding: 24px; margin-bottom: 40px;">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
      <h2 style="margin: 0; color: #f39c12;">‚è≥ Pending Booking Requests ({{ pendingReservations }})</h2>
      <span class="badge warning" style="font-size: 14px; padding: 8px 16px;">Action Required</span>
    </div>
    
    <div class="reservations-grid">
      {% for reservation in recentReservations %}
        {% if reservation.status == 'pending' %}
        <div class="reservation-card pending-card">
          <div class="reservation-header">
            <div class="client-info">
              <div class="client-avatar">{{ reservation.client.email|upper|first }}</div>
              <div>
                <h4>{{ reservation.client.fullName ? reservation.client.fullName : reservation.client.email }}</h4>
                <p class="reservation-type">
                  {% if reservation.service %}
                    üîß {{ reservation.service.title }}
                  {% else %}
                    üöó {{ reservation.announcement.title }}
                  {% endif %}
                </p>
              </div>
            </div>
            <span class="badge warning">Pending</span>
          </div>

          <div class="reservation-details">
            <div class="detail-row">
              <span class="detail-icon">üìÖ</span>
              <div>
                <div class="detail-label">Booking Date</div>
                <div class="detail-value">{{ reservation.reservationDate|date('M d, Y') }}</div>
              </div>
            </div>
            
            {% if reservation.startTime %}
            <div class="detail-row">
              <span class="detail-icon">‚è∞</span>
              <div>
                <div class="detail-label">Time</div>
                <div class="detail-value">{{ reservation.startTime|date('H:i') }}{% if reservation.endTime %} - {{ reservation.endTime|date('H:i') }}{% endif %}</div>
              </div>
            </div>
            {% endif %}

            <div class="detail-row">
              <span class="detail-icon">üí∞</span>
              <div>
                <div class="detail-label">Price</div>
                <div class="detail-value">{{ reservation.price|number_format(0, '.', ',') }} TND</div>
              </div>
            </div>

            {% if reservation.comment %}
            <div class="detail-row full-width">
              <span class="detail-icon">üí¨</span>
              <div>
                <div class="detail-label">Client Notes</div>
                <div class="detail-value">{{ reservation.comment }}</div>
              </div>
            </div>
            {% endif %}
          </div>

          <div class="reservation-actions">
            <form method="post" action="{{ path('app_reservation_confirm', {id: reservation.id}) }}" style="flex: 1;">
              <input type="hidden" name="_token" value="{{ csrf_token('confirm' ~ reservation.id) }}">
              <button type="submit" class="btn yellow btn-block">‚úì Confirm</button>
            </form>
            <form method="post" action="{{ path('app_reservation_cancel', {id: reservation.id}) }}" onsubmit="return confirm('Are you sure you want to decline this booking?');" style="flex: 1;">
              <input type="hidden" name="_token" value="{{ csrf_token('cancel' ~ reservation.id) }}">
              <button type="submit" class="btn danger btn-block">‚úó Decline</button>
            </form>
          </div>
        </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Upcoming Confirmed Bookings -->
  {% set confirmedBookings = recentReservations|filter(r => r.status == 'confirmed') %}
  {% if confirmedBookings|length > 0 %}
  <div class="dashboard-section">
    <h2>‚úÖ Upcoming Confirmed Bookings ({{ confirmedBookings|length }})</h2>
    <div class="reservations-grid">
      {% for reservation in confirmedBookings %}
        <div class="reservation-card confirmed-card">
          <div class="reservation-header">
            <div class="client-info">
              <div class="client-avatar success">{{ reservation.client.email|upper|first }}</div>
              <div>
                <h4>{{ reservation.client.fullName ? reservation.client.fullName : reservation.client.email }}</h4>
                <p class="reservation-type">
                  {% if reservation.service %}
                    üîß {{ reservation.service.title }}
                  {% else %}
                    üöó {{ reservation.announcement.title }}
                  {% endif %}
                </p>
              </div>
            </div>
            <span class="badge success">Confirmed</span>
          </div>

          <div class="reservation-details">
            <div class="detail-row">
              <span class="detail-icon">üìÖ</span>
              <div>
                <div class="detail-label">Booking Date</div>
                <div class="detail-value">{{ reservation.reservationDate|date('M d, Y') }}</div>
              </div>
            </div>
            
            {% if reservation.startTime %}
            <div class="detail-row">
              <span class="detail-icon">‚è∞</span>
              <div>
                <div class="detail-label">Time</div>
                <div class="detail-value">{{ reservation.startTime|date('H:i') }}{% if reservation.endTime %} - {{ reservation.endTime|date('H:i') }}{% endif %}</div>
              </div>
            </div>
            {% endif %}

            <div class="detail-row">
              <span class="detail-icon">üí∞</span>
              <div>
                <div class="detail-label">Price</div>
                <div class="detail-value">{{ reservation.price|number_format(0, '.', ',') }} TND</div>
              </div>
            </div>

            <div class="detail-row">
              <span class="detail-icon">üìû</span>
              <div>
                <div class="detail-label">Contact</div>
                <div class="detail-value">{{ reservation.client.email }}</div>
              </div>
            </div>
          </div>

          <div class="reservation-actions">
            <form method="post" action="{{ path('app_reservation_complete', {id: reservation.id}) }}" style="flex: 1;">
              <input type="hidden" name="_token" value="{{ csrf_token('complete' ~ reservation.id) }}">
              <button type="submit" class="btn success btn-block">‚úì‚úì Mark as Completed</button>
            </form>
            <form method="post" action="{{ path('app_reservation_cancel', {id: reservation.id}) }}" onsubmit="return confirm('Are you sure you want to cancel this booking?');" style="flex: 1;">
              <input type="hidden" name="_token" value="{{ csrf_token('cancel' ~ reservation.id) }}">
              <button type="submit" class="btn secondary btn-block">Cancel</button>
            </form>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- All Bookings Table -->
  {% if recentReservations|length > 0 %}
  <div class="dashboard-section">
    <h2>All Recent Bookings</h2>
    <div class="dashboard-table-wrapper">
      <table class="table">
        <thead>
          <tr>
            <th>Client</th>
            <th>Car/Service</th>
            <th>Date</th>
            <th>Time</th>
            <th>Status</th>
            <th>Price</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for reservation in recentReservations %}
          <tr class="status-{{ reservation.status }}">
            <td>
              <strong>{{ reservation.client.fullName ? reservation.client.fullName : reservation.client.email }}</strong>
              <br><small style="color: var(--muted);">{{ reservation.client.email }}</small>
            </td>
            <td>
              {% if reservation.announcement %}
                üöó {{ reservation.announcement.title }}
              {% elseif reservation.service %}
                üîß {{ reservation.service.title }}
              {% else %}
                Unknown
              {% endif %}
            </td>
            <td>{{ reservation.reservationDate|date('M d, Y') }}</td>
            <td>
              {% if reservation.startTime %}
                {{ reservation.startTime|date('H:i') }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if reservation.status == 'pending' %}
                <span class="badge warning">‚è≥ Pending</span>
              {% elseif reservation.status == 'confirmed' %}
                <span class="badge success">‚úì Confirmed</span>
              {% elseif reservation.status == 'completed' %}
                <span class="badge info">‚úì‚úì Completed</span>
              {% elseif reservation.status == 'cancelled' %}
                <span class="badge danger">‚úó Cancelled</span>
              {% else %}
                <span class="badge">{{ reservation.status|capitalize }}</span>
              {% endif %}
            </td>
            <td><strong>{{ reservation.price ? (reservation.price|number_format(0, '.', ' ')) : 'N/A' }} TND</strong></td>
            <td>
              <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                {% if reservation.status == 'pending' %}
                  <form method="post" action="{{ path('app_reservation_confirm', {id: reservation.id}) }}" style="display: inline;">
                    <input type="hidden" name="_token" value="{{ csrf_token('confirm' ~ reservation.id) }}">
                    <button type="submit" class="btn btn-sm yellow" title="Confirm">‚úì</button>
                  </form>
                  <form method="post" action="{{ path('app_reservation_cancel', {id: reservation.id}) }}" onsubmit="return confirm('Decline this booking?');" style="display: inline;">
                    <input type="hidden" name="_token" value="{{ csrf_token('cancel' ~ reservation.id) }}">
                    <button type="submit" class="btn btn-sm danger" title="Decline">‚úó</button>
                  </form>
                {% elseif reservation.status == 'confirmed' %}
                  <form method="post" action="{{ path('app_reservation_complete', {id: reservation.id}) }}" style="display: inline;">
                    <input type="hidden" name="_token" value="{{ csrf_token('complete' ~ reservation.id) }}">
                    <button type="submit" class="btn btn-sm success" title="Complete">‚úì‚úì</button>
                  </form>
                {% endif %}
                <a href="{{ path('app_reservation_show', {id: reservation.id}) }}" class="btn btn-sm secondary" title="View Details">üëÅÔ∏è</a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% else %}
  <div class="dashboard-section" style="text-align: center; padding: 60px 20px;">
    <p style="color: var(--muted); font-size: 16px; margin-bottom: 20px;">üì≠ No bookings yet</p>
    <p style="color: var(--muted); font-size: 14px;">Your bookings will appear here when clients book your services or listings.</p>
  </div>
  {% endif %}

  {% if announcements|length > 0 %}
  <div class="dashboard-section">
    <h2>Your Car Listings</h2>
    <div class="dashboard-table-wrapper">
      <table class="table">
        <thead>
          <tr>
            <th>Vehicle</th>
            <th>Price</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for announcement in announcements %}
          <tr>
            <td><strong>{{ announcement.title }}</strong></td>
            <td>{{ announcement.price|number_format(0, '.', ' ') }} TND</td>
            <td>
              {% if announcement.status == 'active' %}
                <span class="badge success">Active</span>
              {% else %}
                <span class="badge warning">{{ announcement.status|capitalize }}</span>
              {% endif %}
            </td>
            <td>
              <a href="{{ path('app_announcement_show', {id: announcement.id}) }}" class="btn btn-sm ghost">View</a>
              <a href="{{ path('app_announcement_edit', {id: announcement.id}) }}" class="btn btn-sm secondary">Edit</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {% if services|length > 0 %}
  <div class="dashboard-section">
    <h2>Your Services</h2>
    <div class="dashboard-table-wrapper">
      <table class="table">
        <thead>
          <tr>
            <th>Service</th>
            <th>Price</th>
            <th>Duration</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for service in services %}
          <tr>
            <td><strong>{{ service.title }}</strong></td>
            <td>{{ service.price|number_format(0, '.', ' ') }} TND</td>
            <td>{{ service.duration }} minutes</td>
            <td>
              {% if service.isActive %}
                <span class="badge success">Active</span>
              {% else %}
                <span class="badge warning">Inactive</span>
              {% endif %}
            </td>
            <td>
              <a href="{{ path('app_service_show', {id: service.id}) }}" class="btn btn-sm ghost">View</a>
              <a href="{{ path('app_service_edit', {id: service.id}) }}" class="btn btn-sm secondary">Edit</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {% if announcements|length == 0 and services|length == 0 %}
  <div class="dashboard-section" style="text-align: center; padding: 60px 20px;">
    <p style="color: var(--muted); font-size: 16px; margin-bottom: 20px;">üì≠ You haven't added any services or listings yet</p>
    <div style="display: flex; gap: 10px; justify-content: center;">
      <a href="{{ path('app_service_new') }}" class="btn yellow btn-lg">Create Service</a>
      <a href="{{ path('app_announcement_new') }}" class="btn yellow btn-lg">Create Listing</a>
    </div>
  </div>
  {% endif %}
</div>

<style>
  /* Reservation Management Styles */
  .reservations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }

  .reservation-card {
    background: var(--surface);
    border-radius: 12px;
    padding: 20px;
    border: 2px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
  }

  .reservation-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  }

  .pending-card {
    border-color: rgba(243, 156, 18, 0.4);
    background: linear-gradient(135deg, rgba(243, 156, 18, 0.05) 0%, var(--surface) 100%);
  }

  .confirmed-card {
    border-color: rgba(40, 167, 69, 0.4);
    background: linear-gradient(135deg, rgba(40, 167, 69, 0.05) 0%, var(--surface) 100%);
  }

  .reservation-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .client-info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
  }

  .client-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--primary-dark));
    color: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 18px;
    flex-shrink: 0;
  }

  .client-avatar.success {
    background: linear-gradient(135deg, #28a745, #20c997);
  }

  .client-info h4 {
    margin: 0 0 4px;
    font-size: 16px;
    font-weight: 600;
  }

  .reservation-type {
    margin: 0;
    font-size: 13px;
    color: var(--muted);
  }

  .reservation-details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 16px;
  }

  .detail-row {
    display: flex;
    align-items: start;
    gap: 8px;
  }

  .detail-row.full-width {
    grid-column: 1 / -1;
  }

  .detail-icon {
    font-size: 18px;
    flex-shrink: 0;
    line-height: 1;
  }

  .detail-label {
    font-size: 11px;
    color: var(--muted);
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.5px;
    margin-bottom: 2px;
  }

  .detail-value {
    font-size: 14px;
    font-weight: 500;
    color: var(--text);
  }

  .reservation-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  .reservation-actions form {
    flex: 1;
  }

  .reservation-actions .btn {
    width: 100%;
    font-size: 13px;
    padding: 10px 12px;
    font-weight: 600;
  }

  /* Badge Styles */
  .badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    white-space: nowrap;
  }

  .badge.warning {
    background: rgba(243, 156, 18, 0.2);
    color: #f39c12;
  }

  .badge.success {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
  }

  .badge.info {
    background: rgba(23, 162, 184, 0.2);
    color: #17a2b8;
  }

  .badge.danger {
    background: rgba(220, 53, 69, 0.2);
    color: #dc3545;
  }

  /* Table row coloring based on status */
  .table tbody tr.status-pending {
    background: rgba(243, 156, 18, 0.05);
  }

  .table tbody tr.status-confirmed {
    background: rgba(40, 167, 69, 0.05);
  }

  .table tbody tr.status-completed {
    background: rgba(23, 162, 184, 0.05);
  }

  .table tbody tr.status-cancelled {
    background: rgba(220, 53, 69, 0.05);
    opacity: 0.7;
  }

  /* Button variants */
  .btn.success {
    background: #28a745;
    border-color: #28a745;
    color: white;
  }

  .btn.success:hover {
    background: #218838;
    border-color: #1e7e34;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .reservations-grid {
      grid-template-columns: 1fr;
    }

    .reservation-details {
      grid-template-columns: 1fr;
    }

    .reservation-actions {
      flex-direction: column;
    }

    .dashboard-table-wrapper {
      overflow-x: auto;
    }

    .table {
      min-width: 800px;
    }
  }

  .unread-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 28px;
    height: 28px;
    padding: 0 8px;
    background: #ffc107;
    color: #1a1a1a;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 700;
    flex-shrink: 0;
  }
</style>
{% endblock %}

