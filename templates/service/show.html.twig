{% extends 'base.html.twig' %}

{% block title %}{{ service.title }} - MyAutoSpace{% endblock %}

{% block body %}
<div class="service-detail-container">
  <div class="service-detail-content">
    <div class="service-detail-header">
      <div>
        <h1>{{ service.title }}</h1>
        <p class="service-subtitle">
          <span class="badge badge-{{ service.isActive ? 'success' : 'secondary' }}">
            {{ service.isActive ? 'Active' : 'Inactive' }}
          </span>
          ‚Ä¢ {{ service.category.name }}
        </p>
      </div>
      <a href="#" onclick="goBack(); return false;" class="btn ghost">‚Üê Back</a>
    </div>

    <div class="service-detail-body">
      <div class="service-main">
        {% if service.photo %}
        <div class="service-photo-container">
          <img src="{{ asset('uploads/services/' ~ service.photo) }}" alt="{{ service.title }}" class="service-photo">
        </div>
        {% else %}
        <div class="service-icon-container">
          <div class="service-icon-large">üîß</div>
        </div>
        {% endif %}

        <div class="description-card">
          <h3>Description</h3>
          <p>{{ service.description }}</p>
        </div>

        {% if service.reviews|length > 0 %}
        <div class="reviews-section">
          <h3>Customer Reviews ({{ service.reviews|length }})</h3>
          <div class="reviews-list">
            {% for review in service.reviews %}
            <div class="review-item">
              <div class="review-header">
                <div class="review-author">
                  <div class="author-avatar">{{ review.client.email|upper|first }}</div>
                  <div>
                    <div class="author-name">{{ review.client.fullName ?? review.client.email }}</div>
                    <div class="review-date">{{ review.createdAt|date('M d, Y') }}</div>
                  </div>
                </div>
                <div class="review-rating">
                  {% for i in 1..5 %}
                    <span class="{{ i <= review.rating ? 'star-filled' : 'star-empty' }}">‚òÖ</span>
                  {% endfor %}
                </div>
              </div>
              {% if review.comment %}
              <p class="review-comment">{{ review.comment }}</p>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>

      <div class="service-sidebar">
        <div class="price-card">
          <div class="price-display">{{ service.price|number_format(0, '.', ',') }} TND</div>
          <p class="duration-info">‚è±Ô∏è Duration: {{ service.duration }} minutes</p>
        </div>

        {% if not (is_granted('ROLE_USER') and app.user and app.user.id == service.provider.id) %}
          <div class="action-panel">
            <button class="btn yellow btn-block" onclick="openBookingModal()">üìÖ Book Now</button>
            <button class="btn secondary btn-block">üí¨ Contact Provider</button>
          </div>
        {% endif %}

        <div class="provider-card">
          <h3>Provider</h3>
          <div class="provider-info">
            <div class="provider-avatar">{{ service.provider.email|upper|first }}</div>
            <div>
              <div class="provider-name">{{ service.provider.fullName ?? service.provider.email }}</div>
              <div class="provider-email">{{ service.provider.email }}</div>
            </div>
          </div>
        </div>

        <div class="details-card">
          <h3>Service Details</h3>
          <div class="details-list">
            <div class="detail-item">
              <span class="detail-label">Category</span>
              <span class="detail-value">{{ service.category.name }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Duration</span>
              <span class="detail-value">{{ service.duration }} min</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Status</span>
              <span class="detail-value">{{ service.isActive ? 'Available' : 'Unavailable' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Created</span>
              <span class="detail-value">{{ service.createdAt|date('M d, Y') }}</span>
            </div>
          </div>
        </div>

        {% if is_granted('ROLE_USER') and app.user and app.user.id == service.provider.id %}
          <div class="owner-actions">
            <a href="{{ path('app_service_edit', {id: service.id}) }}" class="btn yellow btn-block">‚úèÔ∏è Edit Service</a>
            <form method="post" action="{{ path('app_service_delete', {'id': service.id}) }}" onsubmit="return confirm('Are you sure you want to delete this service?');" style="margin-top: 12px;">
              <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ service.id) }}">
              <button type="submit" class="btn danger btn-block">üóëÔ∏è Delete Service</button>
            </form>
          </div>
        {% elseif is_granted('ROLE_ADMIN') %}
          <div class="admin-actions">
            <a href="{{ path('app_service_edit', {id: service.id}) }}" class="btn secondary btn-block">‚úèÔ∏è Edit Service</a>
            <form method="post" action="{{ path('app_service_delete', {'id': service.id}) }}" onsubmit="return confirm('Are you sure you want to delete this service?');" style="margin-top: 12px;">
              <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ service.id) }}">
              <button type="submit" class="btn danger btn-block">üóëÔ∏è Delete Service</button>
            </form>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Booking Modal -->
<div id="bookingModal" class="modal">
  <div class="modal-dialog">
    <div class="modal-content-booking">
      <div class="modal-header-booking">
        <h2>Book {{ service.title }}</h2>
        <button class="modal-close-btn" onclick="closeBookingModal()">&times;</button>
      </div>
      <form method="post" action="{{ path('app_reservation_create', {'serviceId': service.id}) }}" class="booking-form">
        <input type="hidden" name="_token" value="{{ csrf_token('create_reservation') }}">
        
        <div class="form-group">
          <label for="reservationDate">Select Date *</label>
          <input type="date" id="reservationDate" name="reservationDate" class="form-control" required min="{{ 'now'|date('Y-m-d') }}">
        </div>

        <div class="form-group">
          <label for="startTime">Start Time *</label>
          <input type="time" id="startTime" name="startTime" class="form-control" required>
        </div>

        <div class="form-group">
          <label for="comment">Additional Notes</label>
          <textarea id="comment" name="comment" class="form-control" rows="3" placeholder="Any special requirements?"></textarea>
        </div>

        <div class="booking-summary">
          <div class="summary-row">
            <span>Service:</span>
            <strong>{{ service.title }}</strong>
          </div>
          <div class="summary-row">
            <span>Duration:</span>
            <strong>{{ service.duration }} minutes</strong>
          </div>
          <div class="summary-row total">
            <span>Total:</span>
            <strong>{{ service.price|number_format(0, '.', ',') }} TND</strong>
          </div>
        </div>

        <div class="modal-actions">
          <button type="submit" class="btn yellow btn-block">Confirm Booking</button>
          <button type="button" class="btn secondary btn-block" onclick="closeBookingModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  .service-detail-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    width: 100%;
  }

  .service-detail-content {
    background: var(--card);
    border-radius: 16px;
    overflow: hidden;
  }

  .service-detail-header {
    padding: 24px 32px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
  }

  .service-detail-header h1 {
    font-size: 28px;
    margin: 0 0 8px;
  }

  .service-subtitle {
    color: var(--muted);
    margin: 0;
    font-size: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
  }

  .badge-success {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
  }

  .badge-secondary {
    background: rgba(108, 117, 125, 0.2);
    color: #6c757d;
  }

  .service-detail-body {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 32px;
    padding: 32px;
  }

  .service-main {
    display: flex;
    flex-direction: column;
    gap: 32px;
  }

  .service-icon-container {
    background: linear-gradient(135deg, var(--accent) 0%, var(--primary-dark) 100%);
    border-radius: 16px;
    padding: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .service-icon-large {
    font-size: 120px;
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
  }

  .service-photo-container {
    border-radius: 16px;
    overflow: hidden;
    background: var(--bg-secondary);
  }

  .service-photo {
    width: 100%;
    height: 400px;
    object-fit: cover;
    display: block;
  }

  .description-card, .reviews-section {
    padding: 24px;
    background: var(--bg-secondary);
    border-radius: 12px;
  }

  .description-card h3, .reviews-section h3 {
    font-size: 18px;
    margin: 0 0 16px;
  }

  .description-card p {
    color: var(--muted);
    line-height: 1.6;
    margin: 0;
  }

  .reviews-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .review-item {
    padding: 16px;
    background: var(--bg);
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.05);
  }

  .review-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 12px;
  }

  .review-author {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .author-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--accent);
    color: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 16px;
  }

  .author-name {
    font-weight: 600;
    font-size: 14px;
  }

  .review-date {
    font-size: 12px;
    color: var(--muted);
  }

  .review-rating {
    display: flex;
    gap: 2px;
  }

  .star-filled {
    color: var(--accent);
    font-size: 16px;
  }

  .star-empty {
    color: rgba(255, 255, 255, 0.2);
    font-size: 16px;
  }

  .review-comment {
    color: var(--muted);
    font-size: 14px;
    line-height: 1.5;
    margin: 0;
  }

  .service-sidebar {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .price-card, .provider-card, .details-card {
    padding: 24px;
    background: var(--bg-secondary);
    border-radius: 12px;
  }

  .price-card {
    text-align: center;
  }

  .price-display {
    font-size: 32px;
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 12px;
  }

  .duration-info {
    color: var(--muted);
    margin: 0;
    font-size: 14px;
  }

  .action-panel {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .provider-card h3, .details-card h3 {
    font-size: 16px;
    margin: 0 0 16px;
  }

  .provider-info {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .provider-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--primary-dark));
    color: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 18px;
  }

  .provider-name {
    font-weight: 600;
    font-size: 15px;
  }

  .provider-email {
    font-size: 13px;
    color: var(--muted);
  }

  .details-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .detail-item {
    display: flex;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  }

  .detail-item:last-child {
    border-bottom: none;
  }

  .detail-label {
    color: var(--muted);
    font-size: 14px;
  }

  .detail-value {
    font-weight: 600;
    font-size: 14px;
  }

  .owner-actions, .admin-actions {
    padding: 20px;
    background: var(--bg-secondary);
    border-radius: 12px;
    border: 2px dashed rgba(255, 255, 255, 0.1);
  }

  .admin-actions {
    border-color: rgba(231, 76, 60, 0.3);
  }

  /* Modal Styles */
  .modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    align-items: center;
    justify-content: center;
  }

  .modal.active {
    display: flex;
  }

  .modal-dialog {
    max-width: 500px;
    width: 90%;
    margin: 20px;
  }

  .modal-content-booking {
    background: var(--surface);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    overflow: hidden;
  }

  .modal-header-booking {
    padding: 24px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header-booking h2 {
    margin: 0;
    font-size: 24px;
  }

  .modal-close-btn {
    background: none;
    border: none;
    color: var(--muted);
    font-size: 32px;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s;
  }

  .modal-close-btn:hover {
    color: var(--text);
  }

  .booking-form {
    padding: 24px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    font-size: 14px;
  }

  .form-control {
    width: 100%;
    padding: 12px 14px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.05);
    color: var(--text);
    font-size: 14px;
    font-family: inherit;
    transition: all 0.2s;
  }

  .form-control:focus {
    background: rgba(255, 255, 255, 0.08);
    border-color: var(--accent);
    outline: none;
  }

  .booking-summary {
    background: var(--bg);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 20px;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    font-size: 14px;
  }

  .summary-row.total {
    border-top: 2px solid rgba(255, 255, 255, 0.1);
    padding-top: 12px;
    margin-top: 8px;
    font-size: 16px;
    color: var(--accent);
  }

  .modal-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  @media (max-width: 1200px) {
    .service-detail-body {
      grid-template-columns: 1fr;
    }

    .service-sidebar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }
  }

  @media (max-width: 768px) {
    .service-detail-container {
      padding: 8px;
    }

    .service-detail-header {
      padding: 16px 20px;
      flex-direction: column;
      align-items: flex-start;
    }

    .service-detail-body {
      padding: 20px;
    }

    .service-icon-container {
      padding: 40px;
    }

    .service-icon-large {
      font-size: 80px;
    }

    .service-sidebar {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  function goBack() {
    const referrer = document.referrer;
    const isOwner = {{ (is_granted('ROLE_USER') and app.user and app.user.id == service.provider.id) ? 'true' : 'false' }};
    const isProvider = {{ is_granted('ROLE_PROVIDER') ? 'true' : 'false' }};
    
    if (referrer && referrer.includes('services')) {
      window.location.href = '{{ path('app_services') }}';
    } else if (isOwner && referrer && referrer.includes('dashboard')) {
      window.location.href = '{{ path('app_dashboard_provider') }}';
    } else if (referrer && referrer.includes(window.location.host)) {
      window.history.back();
    } else {
      window.location.href = '{{ path('app_services') }}';
    }
  }

  function openBookingModal() {
    {% if is_granted('ROLE_USER') %}
      document.getElementById('bookingModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    {% else %}
      alert('Please login to book this service');
      window.location.href = '{{ path('app_login') }}';
    {% endif %}
  }

  function closeBookingModal() {
    document.getElementById('bookingModal').classList.remove('active');
    document.body.style.overflow = 'auto';
  }

  // Close modal on outside click
  document.getElementById('bookingModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
      closeBookingModal();
    }
  });
</script>
{% endblock %}
